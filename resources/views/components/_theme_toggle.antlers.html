{{#
    @name Theme toggle (Mobile Horizontal Toggle)
    @desc The mobile responsive theme toggle component with horizontal toggle for mobile and dropdown for desktop.
    1. Ensure darkMode: 'class' is enabled in tailwind.config.js
    2. Add this partial to your navigation components
#}}

<!-- /components/_theme_toggle.antlers.html -->
<li x-data="themeToggle" class="relative z-20 isolate" x-cloak>
    <!-- Mobile Horizontal Toggle - Visible on small screens -->
    <div class="flex p-1 border rounded-lg sm:hidden bg-neutral-100 dark:bg-neutral-800 border-neutral-200 dark:border-neutral-700">
        <!-- Light Theme Button (Mobile) -->
        <button 
            @click="setTheme('light')"
            :class="{ 
                'bg-white dark:bg-neutral-700 text-amber-500 shadow-sm': theme === 'light',
                'text-neutral-600 dark:text-neutral-400 hover:text-neutral-800 dark:hover:text-neutral-200': theme !== 'light'
            }"
            :aria-pressed="theme === 'light'"
            aria-label="{{ trans:strings.theme_toggle_light }}"
            class="flex items-center justify-center px-3 py-2 rounded-md text-xs font-medium transition-all duration-200 touch-manipulation min-w-0 flex-1">
            {{ svg:sun class="w-4 h-4 stroke-current overflow-visible" alt="" aria-hidden="true" }}
        </button>

        <!-- Dark Theme Button (Mobile) -->
        <button 
            @click="setTheme('dark')"
            :class="{ 
                'bg-white dark:bg-neutral-700 text-amber-500 shadow-sm': theme === 'dark',
                'text-neutral-600 dark:text-neutral-400 hover:text-neutral-800 dark:hover:text-neutral-200': theme !== 'dark'
            }"
            :aria-pressed="theme === 'dark'"
            aria-label="{{ trans:strings.theme_toggle_dark }}"
            class="flex items-center justify-center px-3 py-2 rounded-md text-xs font-medium transition-all duration-200 touch-manipulation min-w-0 flex-1">
            {{ svg:moon class="w-4 h-4 stroke-current overflow-visible" alt="" aria-hidden="true" }}
        </button>

        <!-- System Theme Button (Mobile) -->
        <button 
            @click="setTheme('system')"
            :class="{ 
                'bg-white dark:bg-neutral-700 text-amber-500 shadow-sm': theme === 'system',
                'text-neutral-600 dark:text-neutral-400 hover:text-neutral-800 dark:hover:text-neutral-200': theme !== 'system'
            }"
            :aria-pressed="theme === 'system'"
            aria-label="{{ trans:strings.theme_toggle_system }}"
            class="flex items-center justify-center px-3 py-2 rounded-md text-xs font-medium transition-all duration-200 touch-manipulation min-w-0 flex-1">
            {{ svg:cog class="w-4 h-4 stroke-current overflow-visible" alt="" aria-hidden="true" }}
        </button>
    </div>

    <!-- Desktop Dropdown Toggle - Hidden on small screens -->
    <button 
        @click="dropdownOpen = !dropdownOpen"
        @keydown.escape.stop.prevent="dropdownOpen = false"
        :aria-label="dropdownOpen ? '{{ trans:strings.theme_toggle_toggle_close ?? 'Close theme picker' }}' : '{{ trans:strings.theme_toggle_toggle_open ?? 'Open theme picker' }}'"
        :aria-expanded="dropdownOpen"
        :aria-controls="$id('theme-dropdown')"
        class="items-center hidden p-1 -m-1 sm:flex text-neutral-800 dark:text-neutral-200 hover:text-amber-500 dark:hover:text-amber-500 focus:outline-none focus-visible:ring-2 ring-primary motion-safe:transition-colors">
        
        <!-- Current Theme Icon -->
        <div x-show="theme === 'light'" x-transition.opacity.duration.150ms>
            {{ svg:sun class="w-4 h-4 stroke-current overflow-visible" alt="" aria-hidden="true" }}
        </div>
        <div x-show="theme === 'dark'" x-transition.opacity.duration.150ms>
            {{ svg:moon class="w-4 h-4 stroke-current overflow-visible" alt="" aria-hidden="true" }}
        </div>
        <div x-show="theme === 'system'" x-transition.opacity.duration.150ms>
            <span x-show="systemPrefersDark">
                {{ svg:moon class="w-4 h-4 stroke-current overflow-visible opacity-50" alt="" aria-hidden="true" }}
            </span>
            <span x-show="!systemPrefersDark">
                {{ svg:sun class="w-4 h-4 stroke-current overflow-visible opacity-50" alt="" aria-hidden="true" }}
            </span>
        </div>
    </button>

    <!-- Desktop Dropdown Panel - Hidden on small screens -->
    <div 
        x-show="dropdownOpen"
        @click.outside="dropdownOpen = false"
        @keydown.escape.stop.prevent="dropdownOpen = false"
        x-transition.opacity.duration.150ms
        :id="$id('theme-dropdown')"
        x-ref="panel"
        class="absolute right-0 hidden px-3 py-2 mt-2 -ml-3 bg-white border rounded shadow sm:block dark:bg-neutral-800 border-neutral-900/10 dark:border-neutral-100/10">
        
        <!-- Light Theme Button (Desktop) -->
        <button 
            @click="setTheme('light')"
            :class="{ 'text-amber-500': theme === 'light' }"
            :aria-pressed="theme === 'light'"
            aria-label="{{ trans:strings.theme_toggle_light }}"
            title="{{ trans:strings.theme_toggle_light }}"
            class="py-2 px-1 -mx-1 flex items-center space-x-2 hover:text-amber-500 focus:outline-none focus-visible:ring-2 ring-primary motion-safe:transition-colors w-full">
            {{ svg:sun class="w-4 h-4 stroke-current overflow-visible" alt="" aria-hidden="true" }}
            <span class="text-xs font-bold">{{ trans:strings.theme_toggle_light_short }}</span>
        </button>

        <!-- Dark Theme Button (Desktop) -->
        <button 
            @click="setTheme('dark')"
            :class="{ 'text-amber-500': theme === 'dark' }"
            :aria-pressed="theme === 'dark'"
            aria-label="{{ trans:strings.theme_toggle_dark }}"
            title="{{ trans:strings.theme_toggle_dark }}"
            class="py-2 px-1 -mx-1 flex items-center space-x-2 hover:text-amber-500 focus:outline-none focus-visible:ring-2 ring-primary motion-safe:transition-colors w-full">
            {{ svg:moon class="w-4 h-4 stroke-current overflow-visible" alt="" aria-hidden="true" }}
            <span class="text-xs font-bold">{{ trans:strings.theme_toggle_dark_short }}</span>
        </button>

        <!-- System Theme Button (Desktop) -->
        <button 
            @click="setTheme('system')"
            :class="{ 'text-amber-500': theme === 'system' }"
            :aria-pressed="theme === 'system'"
            aria-label="{{ trans:strings.theme_toggle_system }}"
            title="{{ trans:strings.theme_toggle_system }}"
            class="py-2 px-1 -mx-1 flex items-center space-x-2 hover:text-amber-500 focus:outline-none focus-visible:ring-2 ring-primary motion-safe:transition-colors w-full">
            {{ svg:cog class="w-4 h-4 stroke-current overflow-visible" alt="" aria-hidden="true" }}
            <span class="text-xs font-bold">{{ trans:strings.theme_toggle_system_short }}</span>
        </button>
    </div>
</li>

<script>
document.addEventListener('alpine:initializing', () => {
    // Theme store for global theme state
    Alpine.store('theme', {
        theme: Alpine.$persist('system').as('theme'),
        
        set(value) {
            this.theme = value;
        },
        
        get() {
            return this.theme;
        }
    });

    // Theme toggle component
    Alpine.data('themeToggle', () => ({
        // Component state
        dropdownOpen: false,
        systemPrefersDark: window.matchMedia('(prefers-color-scheme: dark)').matches,
        
        // Reactive theme property
        get theme() {
            return this.$store.theme.get();
        },
        
        // Initialize component
        init() {
            // Listen for system preference changes
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            mediaQuery.addEventListener('change', (e) => {
                this.systemPrefersDark = e.matches;
                if (this.theme === 'system') {
                    this.applyTheme();
                }
            });
            
            // Apply initial theme
            this.applyTheme();
        },
        
        // Set theme and close dropdown
        setTheme(newTheme) {
            this.$store.theme.set(newTheme);
            this.applyTheme();
            this.dropdownOpen = false;
        },
        
        // Apply theme to document
        applyTheme() {
            const isDark = this.theme === 'dark' || (this.theme === 'system' && this.systemPrefersDark);
            
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            // Update theme-color meta tag if enabled
            this.updateThemeColor(isDark);
        },
        
        // Update theme-color meta tag
        updateThemeColor(isDark) {
            {{ if browser_appearance:use_theme_color }}
            const themeColorMeta = document.querySelector('meta[name=theme-color]');
            if (themeColorMeta) {
                const lightColor = '{{ browser_appearance:theme_color }}';
                const darkColor = '{{ browser_appearance:theme_color_dark_mode ?? browser_appearance:theme_color }}';
                themeColorMeta.setAttribute('content', isDark ? darkColor : lightColor);
            }
            {{ /if }}
        }
    }));
});
</script>
<!-- End: /components/_theme_toggle.antlers.html -->